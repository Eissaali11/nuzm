{% extends 'mobile/layout.html' %}

{% block title %}{{ employee.name }} - نظام إدارة الموظفين{% endblock %}

{% block header_title %}تفاصيل الموظف{% endblock %}

{% block header_actions %}
<button class="mobile-menu-button" aria-label="قائمة" onclick="toggleActionMenu()">
    <i class="fas fa-ellipsis-v"></i>
</button>
{% endblock %}

{% block content %}
<style>
/* بطاقة الملف الشخصي */
.profile-banner {
    background: linear-gradient(135deg, #4A90E2 0%, #357ABD 100%);
    border-radius: 0 0 24px 24px;
    padding: 30px 20px 40px;
    margin: -20px -20px 20px -20px;
    position: relative;
    text-align: center;
}

.profile-avatar-wrapper {
    width: 100px;
    height: 100px;
    margin: 0 auto 15px;
    position: relative;
}

.profile-avatar {
    width: 100%;
    height: 100%;
    background: white;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: hidden;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    border: 4px solid white;
}

.profile-avatar i {
    font-size: 40px;
    color: #8e8e93;
}

.profile-img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.profile-name {
    font-size: 24px;
    font-weight: 700;
    color: white;
    margin-bottom: 5px;
}

.profile-job-title {
    font-size: 15px;
    color: rgba(255, 255, 255, 0.9);
    margin-bottom: 0;
}

/* البطاقات */
.info-cards-wrapper {
    padding: 0 20px;
    margin-bottom: 80px;
}

.info-card {
    background: white;
    border-radius: 16px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
    border: 1px solid #f0f0f5;
    margin-bottom: 16px;
    overflow: hidden;
}

.card-header {
    padding: 16px;
    background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
    border-bottom: 1px solid #f0f0f5;
    display: flex;
    align-items: center;
    gap: 10px;
}

.card-icon {
    width: 36px;
    height: 36px;
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 16px;
}

.card-icon.primary {
    background: rgba(74, 144, 226, 0.1);
    color: #4A90E2;
}

.card-icon.success {
    background: rgba(52, 199, 89, 0.1);
    color: #34C759;
}

.card-icon.warning {
    background: rgba(255, 149, 0, 0.1);
    color: #FF9500;
}

.card-icon.danger {
    background: rgba(255, 59, 48, 0.1);
    color: #FF3B30;
}

.card-icon.info {
    background: rgba(0, 122, 255, 0.1);
    color: #007AFF;
}

.card-title {
    font-size: 16px;
    font-weight: 600;
    color: #1a1a1a;
    margin: 0;
    flex: 1;
}

.card-content {
    padding: 0;
}

.info-item {
    display: flex;
    align-items: flex-start;
    padding: 14px 16px;
    border-bottom: 1px solid #f0f0f5;
}

.info-item:last-child {
    border-bottom: none;
}

.info-label {
    font-size: 13px;
    color: #8e8e93;
    font-weight: 500;
    flex: 0 0 110px;
}

.info-value {
    font-size: 14px;
    color: #1a1a1a;
    font-weight: 500;
    flex: 1;
    word-break: break-word;
}

.info-value a {
    color: #4A90E2;
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    gap: 6px;
}

.info-value a:active {
    opacity: 0.7;
}

.status-badge {
    padding: 4px 10px;
    border-radius: 10px;
    font-size: 12px;
    font-weight: 500;
    display: inline-block;
}

.status-badge.active {
    background: rgba(52, 199, 89, 0.1);
    color: #34C759;
}

.status-badge.inactive {
    background: rgba(255, 59, 48, 0.1);
    color: #FF3B30;
}

/* صورة الهوية */
.id-image-container {
    padding: 16px;
}

.id-image {
    width: 100%;
    border-radius: 12px;
    cursor: pointer;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    transition: transform 0.2s ease;
}

.id-image:active {
    transform: scale(0.98);
}

/* سجلات الحضور */
.attendance-record {
    padding: 14px 16px;
    border-bottom: 1px solid #f0f0f5;
}

.attendance-record:last-child {
    border-bottom: none;
}

.record-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 8px;
}

.record-date {
    font-size: 14px;
    font-weight: 600;
    color: #1a1a1a;
}

.attendance-status {
    padding: 3px 8px;
    border-radius: 10px;
    font-size: 11px;
    font-weight: 500;
}

.attendance-status.present {
    background: rgba(52, 199, 89, 0.1);
    color: #34C759;
}

.attendance-status.absent {
    background: rgba(255, 59, 48, 0.1);
    color: #FF3B30;
}

.attendance-status.leave {
    background: rgba(74, 144, 226, 0.1);
    color: #4A90E2;
}

.record-times {
    display: flex;
    gap: 16px;
    font-size: 12px;
    color: #8e8e93;
}

.record-time {
    display: flex;
    align-items: center;
    gap: 4px;
}

/* معلومات الراتب */
.salary-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 14px 16px;
    border-bottom: 1px solid #f0f0f5;
}

.salary-item:last-child {
    border-bottom: none;
}

.salary-item.total {
    background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
    font-weight: 700;
}

.salary-label {
    font-size: 14px;
    color: #8e8e93;
    font-weight: 500;
}

.salary-item.total .salary-label {
    color: #1a1a1a;
    font-size: 15px;
}

.salary-value {
    font-size: 15px;
    font-weight: 600;
    color: #1a1a1a;
}

.salary-item.total .salary-value {
    font-size: 18px;
    color: #4A90E2;
}

/* الوثائق */
.document-item {
    padding: 14px 16px;
    border-bottom: 1px solid #f0f0f5;
}

.document-item:last-child {
    border-bottom: none;
}

.document-name {
    font-size: 14px;
    font-weight: 600;
    color: #1a1a1a;
    margin-bottom: 6px;
}

.document-meta {
    display: flex;
    flex-wrap: wrap;
    gap: 12px;
    font-size: 12px;
    color: #8e8e93;
    align-items: center;
}

.document-meta-item {
    display: flex;
    align-items: center;
    gap: 4px;
}

.doc-status {
    padding: 3px 8px;
    border-radius: 10px;
    font-size: 11px;
    font-weight: 500;
}

.doc-status.valid {
    background: rgba(52, 199, 89, 0.1);
    color: #34C759;
}

.doc-status.expired {
    background: rgba(255, 59, 48, 0.1);
    color: #FF3B30;
}

.doc-status.expiring {
    background: rgba(255, 149, 0, 0.1);
    color: #FF9500;
}

.doc-status.undefined {
    background: rgba(142, 142, 147, 0.1);
    color: #8e8e93;
}

/* حالة فارغة */
.empty-state {
    text-align: center;
    padding: 40px 20px;
}

.empty-icon {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    background: rgba(142, 142, 147, 0.1);
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 12px;
}

.empty-icon i {
    font-size: 24px;
    color: #8e8e93;
}

.empty-text {
    font-size: 14px;
    color: #8e8e93;
}

/* قائمة الإجراءات العائمة */
.action-menu-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    z-index: 9998;
}

.action-menu-overlay.active {
    display: block;
}

.action-menu {
    position: fixed;
    bottom: -400px;
    left: 0;
    right: 0;
    background: white;
    border-radius: 24px 24px 0 0;
    padding: 20px;
    z-index: 9999;
    box-shadow: 0 -4px 16px rgba(0, 0, 0, 0.1);
    transition: bottom 0.3s ease;
}

.action-menu.active {
    bottom: 0;
}

.action-menu-header {
    text-align: center;
    padding-bottom: 16px;
    border-bottom: 1px solid #f0f0f5;
    margin-bottom: 16px;
}

.action-menu-title {
    font-size: 18px;
    font-weight: 600;
    color: #1a1a1a;
    margin: 0;
}

.action-menu-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 14px;
    border-radius: 12px;
    margin-bottom: 8px;
    text-decoration: none;
    transition: background 0.2s ease;
}

.action-menu-item:active {
    background: #f0f0f5;
}

.action-menu-icon {
    width: 40px;
    height: 40px;
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 16px;
    flex-shrink: 0;
}

.action-menu-icon.edit {
    background: rgba(74, 144, 226, 0.1);
    color: #4A90E2;
}

.action-menu-icon.pdf {
    background: rgba(255, 59, 48, 0.1);
    color: #FF3B30;
}

.action-menu-icon.excel {
    background: rgba(52, 199, 89, 0.1);
    color: #34C759;
}

.action-menu-icon.back {
    background: rgba(142, 142, 147, 0.1);
    color: #8e8e93;
}

.action-menu-text {
    flex: 1;
}

.action-menu-label {
    font-size: 15px;
    font-weight: 500;
    color: #1a1a1a;
    display: block;
    margin-bottom: 2px;
}

.action-menu-desc {
    font-size: 12px;
    color: #8e8e93;
}

/* Modal الصورة */
.image-modal {
    display: none;
    position: fixed;
    z-index: 10000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.95);
}

.modal-close {
    position: absolute;
    top: 20px;
    right: 20px;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.2);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 24px;
    cursor: pointer;
    z-index: 10001;
}

.modal-image {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    max-width: 90%;
    max-height: 90%;
    border-radius: 8px;
}
</style>

<!-- بطاقة الملف الشخصي -->
<div class="profile-banner">
    <div class="profile-avatar-wrapper">
        <div class="profile-avatar">
            {% if employee.profile_image %}
            <img src="{{ url_for('static', filename=employee.profile_image) }}" alt="{{ employee.name }}" class="profile-img">
            {% else %}
            <i class="fas fa-user"></i>
            {% endif %}
        </div>
    </div>
    <h1 class="profile-name">{{ employee.name }}</h1>
    <p class="profile-job-title">{{ employee.job_title }}</p>
</div>

<div class="info-cards-wrapper">
    <!-- بطاقة المعلومات الأساسية -->
    <div class="info-card">
        <div class="card-header">
            <div class="card-icon primary">
                <i class="fas fa-id-card"></i>
            </div>
            <h2 class="card-title">المعلومات الأساسية</h2>
        </div>
        <div class="card-content">
            <div class="info-item">
                <div class="info-label">الرقم الوظيفي</div>
                <div class="info-value">{{ employee.employee_id }}</div>
            </div>
            <div class="info-item">
                <div class="info-label">القسم</div>
                <div class="info-value">{{ employee.department.name if employee.department else 'غير محدد' }}</div>
            </div>
            <div class="info-item">
                <div class="info-label">المسمى الوظيفي</div>
                <div class="info-value">{{ employee.job_title }}</div>
            </div>
            <div class="info-item">
                <div class="info-label">تاريخ التعيين</div>
                <div class="info-value">
                    {% if employee.hire_date %}
                    {{ employee.hire_date.strftime('%Y-%m-%d') }}
                    {% else %}
                    <span style="color: #c7c7cc;">غير متوفر</span>
                    {% endif %}
                </div>
            </div>
            <div class="info-item">
                <div class="info-label">الحالة</div>
                <div class="info-value">
                    {% if employee.active %}
                    <span class="status-badge active">نشط</span>
                    {% else %}
                    <span class="status-badge inactive">غير نشط</span>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- بطاقة معلومات الاتصال -->
    <div class="info-card">
        <div class="card-header">
            <div class="card-icon success">
                <i class="fas fa-phone"></i>
            </div>
            <h2 class="card-title">معلومات الاتصال</h2>
        </div>
        <div class="card-content">
            <div class="info-item">
                <div class="info-label">رقم الجوال</div>
                <div class="info-value">
                    {% if employee.mobile %}
                    <a href="tel:{{ employee.mobile }}">
                        <i class="fas fa-phone"></i> {{ employee.mobile }}
                    </a>
                    {% else %}
                    <span style="color: #c7c7cc;">غير متوفر</span>
                    {% endif %}
                </div>
            </div>
            {% if employee.mobilePersonal %}
            <div class="info-item">
                <div class="info-label">الجوال الشخصي</div>
                <div class="info-value">
                    <a href="tel:{{ employee.mobilePersonal }}">
                        <i class="fas fa-mobile-alt"></i> {{ employee.mobilePersonal }}
                    </a>
                </div>
            </div>
            {% endif %}
            <div class="info-item">
                <div class="info-label">البريد الإلكتروني</div>
                <div class="info-value">
                    {% if employee.email %}
                    <a href="mailto:{{ employee.email }}">{{ employee.email }}</a>
                    {% else %}
                    <span style="color: #c7c7cc;">غير متوفر</span>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- بطاقة المعلومات الشخصية -->
    <div class="info-card">
        <div class="card-header">
            <div class="card-icon warning">
                <i class="fas fa-user-circle"></i>
            </div>
            <h2 class="card-title">المعلومات الشخصية</h2>
        </div>
        <div class="card-content">
            <div class="info-item">
                <div class="info-label">الجنسية</div>
                <div class="info-value">{{ employee.nationality or 'غير محدد' }}</div>
            </div>
            <div class="info-item">
                <div class="info-label">رقم الهوية</div>
                <div class="info-value">{{ employee.national_id or 'غير متوفر' }}</div>
            </div>
            {% if employee.passport_number %}
            <div class="info-item">
                <div class="info-label">رقم الجواز</div>
                <div class="info-value">{{ employee.passport_number }}</div>
            </div>
            {% endif %}
            {% if employee.date_of_birth %}
            <div class="info-item">
                <div class="info-label">تاريخ الميلاد</div>
                <div class="info-value">{{ employee.date_of_birth.strftime('%Y-%m-%d') }}</div>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- بطاقة صورة الهوية -->
    {% if employee.national_id_image %}
    <div class="info-card">
        <div class="card-header">
            <div class="card-icon info">
                <i class="fas fa-image"></i>
            </div>
            <h2 class="card-title">صورة الهوية الوطنية</h2>
        </div>
        <div class="id-image-container">
            <img src="{{ url_for('static', filename=employee.national_id_image) }}" 
                 alt="الهوية الوطنية" 
                 class="id-image"
                 onclick="openImageModal(this.src)">
        </div>
    </div>
    {% endif %}

    <!-- بطاقة الحضور الأخير -->
    {% if attendance_records %}
    <div class="info-card">
        <div class="card-header">
            <div class="card-icon success">
                <i class="fas fa-calendar-check"></i>
            </div>
            <h2 class="card-title">سجل الحضور الأخير</h2>
        </div>
        <div class="card-content">
            {% for record in attendance_records[:5] %}
            <div class="attendance-record">
                <div class="record-header">
                    <span class="record-date">{{ record.date }}</span>
                    <span class="attendance-status 
                        {% if record.status == 'حاضر' %}present
                        {% elif record.status == 'غائب' %}absent
                        {% elif record.status == 'إجازة' %}leave
                        {% endif %}">
                        {{ record.status }}
                    </span>
                </div>
                <div class="record-times">
                    <div class="record-time">
                        <i class="fas fa-sign-in-alt"></i>
                        <span>{{ record.check_in }}</span>
                    </div>
                    <div class="record-time">
                        <i class="fas fa-sign-out-alt"></i>
                        <span>{{ record.check_out }}</span>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <!-- بطاقة معلومات الراتب -->
    {% if salary %}
    <div class="info-card">
        <div class="card-header">
            <div class="card-icon success">
                <i class="fas fa-money-bill-wave"></i>
            </div>
            <h2 class="card-title">معلومات الراتب</h2>
        </div>
        <div class="card-content">
            <div class="salary-item">
                <span class="salary-label">الراتب الأساسي</span>
                <span class="salary-value">{{ '{:,.2f}'.format(salary.basic_salary) }} ريال</span>
            </div>
            <div class="salary-item">
                <span class="salary-label">البدلات</span>
                <span class="salary-value">{{ '{:,.2f}'.format(salary.allowances) }} ريال</span>
            </div>
            <div class="salary-item">
                <span class="salary-label">المكافآت</span>
                <span class="salary-value">{{ '{:,.2f}'.format(salary.bonus) }} ريال</span>
            </div>
            <div class="salary-item">
                <span class="salary-label">الخصومات</span>
                <span class="salary-value">{{ '{:,.2f}'.format(salary.deductions) }} ريال</span>
            </div>
            <div class="salary-item total">
                <span class="salary-label">صافي الراتب</span>
                <span class="salary-value">{{ '{:,.2f}'.format(salary.net_salary) }} ريال</span>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- بطاقة الوثائق -->
    {% if documents %}
    <div class="info-card">
        <div class="card-header">
            <div class="card-icon danger">
                <i class="fas fa-file-alt"></i>
            </div>
            <h2 class="card-title">الوثائق</h2>
        </div>
        <div class="card-content">
            {% for doc in documents %}
            <div class="document-item">
                <div class="document-name">{{ doc.name }}</div>
                <div class="document-meta">
                    <div class="document-meta-item">
                        <i class="fas fa-hashtag"></i>
                        <span>{{ doc.document_number }}</span>
                    </div>
                    <div class="document-meta-item">
                        <i class="fas fa-calendar"></i>
                        <span>{{ doc.issue_date.strftime('%Y-%m-%d') }}</span>
                    </div>
                    {% if doc.expiry_date %}
                        {% if doc.expiry_date < current_date %}
                        <span class="doc-status expired">منتهية</span>
                        {% elif (doc.expiry_date - current_date).days <= 30 %}
                        <span class="doc-status expiring">تنتهي قريباً</span>
                        {% else %}
                        <span class="doc-status valid">سارية</span>
                        {% endif %}
                    {% else %}
                    <span class="doc-status undefined">غير محدد</span>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}
</div>

<!-- قائمة الإجراءات -->
<div class="action-menu-overlay" id="actionMenuOverlay" onclick="toggleActionMenu()"></div>
<div class="action-menu" id="actionMenu">
    <div class="action-menu-header">
        <h3 class="action-menu-title">الإجراءات</h3>
    </div>
    
    <a href="{{ url_for('mobile.edit_employee', employee_id=employee.id) }}" class="action-menu-item">
        <div class="action-menu-icon edit">
            <i class="fas fa-edit"></i>
        </div>
        <div class="action-menu-text">
            <span class="action-menu-label">تعديل البيانات</span>
            <span class="action-menu-desc">تحديث معلومات الموظف</span>
        </div>
    </a>
    
    <a href="{{ url_for('documents.export_employee_documents_pdf', employee_id=employee.id) }}" class="action-menu-item">
        <div class="action-menu-icon pdf">
            <i class="fas fa-file-pdf"></i>
        </div>
        <div class="action-menu-text">
            <span class="action-menu-label">تصدير PDF</span>
            <span class="action-menu-desc">تنزيل تقرير شامل بصيغة PDF</span>
        </div>
    </a>
    
    <a href="{{ url_for('salaries.comprehensive_report') }}?employee_id={{ employee.id }}" class="action-menu-item" onclick="event.preventDefault(); exportExcel();">
        <div class="action-menu-icon excel">
            <i class="fas fa-file-excel"></i>
        </div>
        <div class="action-menu-text">
            <span class="action-menu-label">تصدير Excel</span>
            <span class="action-menu-desc">تنزيل تقرير شامل بصيغة Excel</span>
        </div>
    </a>
    
    <a href="{{ url_for('mobile.employees') }}" class="action-menu-item">
        <div class="action-menu-icon back">
            <i class="fas fa-arrow-right"></i>
        </div>
        <div class="action-menu-text">
            <span class="action-menu-label">العودة للقائمة</span>
            <span class="action-menu-desc">الرجوع إلى قائمة الموظفين</span>
        </div>
    </a>
</div>

<!-- Modal الصورة -->
<div id="imageModal" class="image-modal" onclick="closeImageModal()">
    <div class="modal-close" onclick="closeImageModal()">
        <i class="fas fa-times"></i>
    </div>
    <img id="modalImage" class="modal-image">
</div>

{% endblock %}

{% block scripts %}
<script>
// فتح/إغلاق قائمة الإجراءات
function toggleActionMenu() {
    const menu = document.getElementById('actionMenu');
    const overlay = document.getElementById('actionMenuOverlay');
    
    menu.classList.toggle('active');
    overlay.classList.toggle('active');
    
    if (menu.classList.contains('active')) {
        document.body.style.overflow = 'hidden';
    } else {
        document.body.style.overflow = 'auto';
    }
}

// تصدير Excel
function exportExcel() {
    // إنشاء نموذج وإرساله
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = '{{ url_for("salaries.comprehensive_report") }}';
    
    // إضافة حقل employee_id
    const employeeIdField = document.createElement('input');
    employeeIdField.type = 'hidden';
    employeeIdField.name = 'employee_id';
    employeeIdField.value = '{{ employee.id }}';
    form.appendChild(employeeIdField);
    
    document.body.appendChild(form);
    form.submit();
    document.body.removeChild(form);
    
    // إغلاق القائمة
    toggleActionMenu();
}

// فتح وإغلاق modal الصورة
function openImageModal(imageSrc) {
    const modal = document.getElementById('imageModal');
    const modalImg = document.getElementById('modalImage');
    
    modal.style.display = 'block';
    modalImg.src = imageSrc;
    document.body.style.overflow = 'hidden';
}

function closeImageModal() {
    const modal = document.getElementById('imageModal');
    modal.style.display = 'none';
    document.body.style.overflow = 'auto';
}

// إغلاق modal بالضغط على Escape
document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape') {
        closeImageModal();
        
        const menu = document.getElementById('actionMenu');
        if (menu.classList.contains('active')) {
            toggleActionMenu();
        }
    }
});
</script>
{% endblock %}
