{% extends 'layout.html' %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
    :root {
        --pbi-yellow: #F2C811;
        --pbi-dark: #1B1B1B;
        --pbi-gray-dark: #252423;
        --pbi-gray: #3B3A39;
        --pbi-gray-light: #605E5C;
        --pbi-white: #FFFFFF;
        --pbi-blue: #0078D4;
        --pbi-green: #107C10;
        --pbi-red: #D83B01;
        --pbi-purple: #8764B8;
        --pbi-teal: #00B7C3;
        --pbi-orange: #FF8C00;
        --gradient-primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        --gradient-success: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        --gradient-danger: linear-gradient(135deg, #ff416c 0%, #ff4b2b 100%);
        --gradient-warning: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        --gradient-info: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        --gradient-dark: linear-gradient(135deg, #232526 0%, #414345 100%);
    }

    * {
        box-sizing: border-box;
    }

    .powerbi-container {
        background: linear-gradient(180deg, #0f0f23 0%, #1a1a2e 50%, #16213e 100%);
        min-height: 100vh;
        padding: 0;
        direction: rtl;
    }

    .pbi-header {
        background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
        padding: 1.5rem 2rem;
        border-bottom: 3px solid var(--pbi-yellow);
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 1rem;
    }

    .pbi-logo {
        display: flex;
        align-items: center;
        gap: 1rem;
    }

    .pbi-logo-icon {
        width: 50px;
        height: 50px;
        background: var(--pbi-yellow);
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        color: var(--pbi-dark);
        box-shadow: 0 4px 15px rgba(242, 200, 17, 0.4);
    }

    .pbi-title {
        color: var(--pbi-white);
        font-size: 1.75rem;
        font-weight: 700;
        margin: 0;
    }

    .pbi-subtitle {
        color: var(--pbi-gray-light);
        font-size: 0.9rem;
        margin: 0;
    }

    .pbi-actions {
        display: flex;
        gap: 0.75rem;
    }

    .pbi-btn {
        padding: 0.6rem 1.2rem;
        border-radius: 8px;
        border: none;
        cursor: pointer;
        font-weight: 600;
        font-size: 0.9rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        transition: all 0.3s ease;
    }

    .pbi-btn-primary {
        background: var(--pbi-yellow);
        color: var(--pbi-dark);
    }

    .pbi-btn-primary:hover {
        background: #ffd93d;
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(242, 200, 17, 0.4);
    }

    .pbi-btn-secondary {
        background: var(--pbi-gray);
        color: var(--pbi-white);
    }

    .pbi-btn-secondary:hover {
        background: var(--pbi-gray-light);
    }

    .pbi-btn-success {
        background: var(--gradient-success);
        color: white;
    }

    .pbi-btn-success:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(17, 153, 142, 0.4);
    }

    .pbi-main {
        padding: 1.5rem;
    }

    .filter-panel {
        background: rgba(255, 255, 255, 0.05);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 16px;
        padding: 1.25rem;
        margin-bottom: 1.5rem;
        display: flex;
        gap: 1rem;
        flex-wrap: wrap;
        align-items: flex-end;
    }

    .filter-group {
        flex: 1;
        min-width: 180px;
    }

    .filter-label {
        display: block;
        color: var(--pbi-gray-light);
        font-size: 0.8rem;
        margin-bottom: 0.5rem;
        font-weight: 500;
    }

    .filter-input {
        width: 100%;
        padding: 0.65rem 1rem;
        background: rgba(255, 255, 255, 0.08);
        border: 1px solid rgba(255, 255, 255, 0.15);
        border-radius: 8px;
        color: var(--pbi-white);
        font-size: 0.95rem;
        transition: all 0.3s;
    }

    .filter-input:focus {
        outline: none;
        border-color: var(--pbi-yellow);
        box-shadow: 0 0 0 3px rgba(242, 200, 17, 0.15);
    }

    .filter-input option {
        background: var(--pbi-gray-dark);
        color: var(--pbi-white);
    }

    .kpi-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 1rem;
        margin-bottom: 1.5rem;
    }

    .kpi-card {
        background: rgba(255, 255, 255, 0.05);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 16px;
        padding: 1.25rem;
        position: relative;
        overflow: hidden;
        transition: all 0.3s ease;
    }

    .kpi-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 15px 40px rgba(0, 0, 0, 0.3);
        border-color: rgba(242, 200, 17, 0.3);
    }

    .kpi-card::before {
        content: '';
        position: absolute;
        top: 0;
        right: 0;
        width: 100%;
        height: 4px;
        background: var(--kpi-color, var(--pbi-yellow));
    }

    .kpi-icon {
        width: 48px;
        height: 48px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.4rem;
        margin-bottom: 1rem;
        background: var(--kpi-gradient, var(--gradient-primary));
        color: white;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
    }

    .kpi-value {
        font-size: 2rem;
        font-weight: 700;
        color: var(--pbi-white);
        margin-bottom: 0.25rem;
        display: flex;
        align-items: baseline;
        gap: 0.5rem;
    }

    .kpi-value .trend {
        font-size: 0.9rem;
        padding: 0.2rem 0.5rem;
        border-radius: 20px;
        font-weight: 600;
    }

    .trend-up {
        background: rgba(17, 153, 142, 0.2);
        color: #38ef7d;
    }

    .trend-down {
        background: rgba(239, 68, 68, 0.2);
        color: #ef4444;
    }

    .kpi-label {
        color: var(--pbi-gray-light);
        font-size: 0.9rem;
        font-weight: 500;
    }

    .kpi-sub {
        color: rgba(255, 255, 255, 0.4);
        font-size: 0.8rem;
        margin-top: 0.5rem;
    }

    .charts-grid {
        display: grid;
        grid-template-columns: repeat(12, 1fr);
        gap: 1.5rem;
    }

    .chart-card {
        background: rgba(255, 255, 255, 0.05);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 16px;
        padding: 1.25rem;
        transition: all 0.3s ease;
    }

    .chart-card:hover {
        border-color: rgba(242, 200, 17, 0.3);
    }

    .chart-card.span-6 { grid-column: span 6; }
    .chart-card.span-4 { grid-column: span 4; }
    .chart-card.span-8 { grid-column: span 8; }
    .chart-card.span-12 { grid-column: span 12; }
    .chart-card.span-3 { grid-column: span 3; }

    @media (max-width: 1200px) {
        .chart-card.span-6,
        .chart-card.span-4,
        .chart-card.span-8,
        .chart-card.span-3 { grid-column: span 12; }
    }

    .chart-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
        padding-bottom: 0.75rem;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .chart-title {
        color: var(--pbi-white);
        font-size: 1rem;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .chart-title i {
        color: var(--pbi-yellow);
    }

    .chart-actions {
        display: flex;
        gap: 0.5rem;
    }

    .chart-action-btn {
        background: rgba(255, 255, 255, 0.1);
        border: none;
        color: var(--pbi-gray-light);
        width: 32px;
        height: 32px;
        border-radius: 8px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s;
    }

    .chart-action-btn:hover {
        background: var(--pbi-yellow);
        color: var(--pbi-dark);
    }

    .chart-container {
        position: relative;
        height: 280px;
        width: 100%;
    }

    .chart-container.small {
        height: 200px;
    }

    .chart-container.large {
        height: 350px;
    }

    .stat-mini-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 0.75rem;
    }

    .stat-mini {
        background: rgba(255, 255, 255, 0.05);
        border-radius: 12px;
        padding: 1rem;
        text-align: center;
    }

    .stat-mini-value {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--pbi-white);
    }

    .stat-mini-label {
        font-size: 0.75rem;
        color: var(--pbi-gray-light);
        margin-top: 0.25rem;
    }

    .data-table-wrapper {
        max-height: 350px;
        overflow-y: auto;
    }

    .data-table-wrapper::-webkit-scrollbar {
        width: 6px;
    }

    .data-table-wrapper::-webkit-scrollbar-track {
        background: rgba(255, 255, 255, 0.05);
        border-radius: 3px;
    }

    .data-table-wrapper::-webkit-scrollbar-thumb {
        background: var(--pbi-yellow);
        border-radius: 3px;
    }

    .pbi-table {
        width: 100%;
        border-collapse: collapse;
    }

    .pbi-table th {
        background: rgba(242, 200, 17, 0.1);
        color: var(--pbi-yellow);
        padding: 0.75rem;
        text-align: right;
        font-size: 0.85rem;
        font-weight: 600;
        position: sticky;
        top: 0;
        z-index: 1;
    }

    .pbi-table td {
        padding: 0.65rem 0.75rem;
        color: var(--pbi-white);
        font-size: 0.9rem;
        border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    }

    .pbi-table tbody tr {
        transition: background 0.3s;
    }

    .pbi-table tbody tr:hover {
        background: rgba(242, 200, 17, 0.05);
    }

    .badge {
        display: inline-flex;
        align-items: center;
        gap: 0.35rem;
        padding: 0.35rem 0.75rem;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 600;
    }

    .badge-success {
        background: rgba(17, 153, 142, 0.2);
        color: #38ef7d;
    }

    .badge-warning {
        background: rgba(245, 158, 11, 0.2);
        color: #fbbf24;
    }

    .badge-danger {
        background: rgba(239, 68, 68, 0.2);
        color: #f87171;
    }

    .badge-info {
        background: rgba(59, 130, 246, 0.2);
        color: #60a5fa;
    }

    .progress-bar-wrapper {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 10px;
        height: 8px;
        overflow: hidden;
        width: 100%;
    }

    .progress-bar {
        height: 100%;
        border-radius: 10px;
        transition: width 1s ease;
    }

    .progress-bar.success { background: var(--gradient-success); }
    .progress-bar.warning { background: linear-gradient(135deg, #f59e0b 0%, #fbbf24 100%); }
    .progress-bar.danger { background: var(--gradient-danger); }
    .progress-bar.info { background: var(--gradient-info); }

    .insight-card {
        background: linear-gradient(135deg, rgba(242, 200, 17, 0.1) 0%, rgba(102, 126, 234, 0.1) 100%);
        border: 1px solid rgba(242, 200, 17, 0.2);
        border-radius: 12px;
        padding: 1rem;
        margin-top: 1rem;
    }

    .insight-title {
        color: var(--pbi-yellow);
        font-size: 0.9rem;
        font-weight: 600;
        margin-bottom: 0.5rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .insight-text {
        color: rgba(255, 255, 255, 0.8);
        font-size: 0.85rem;
        line-height: 1.6;
    }

    .loading-spinner {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 200px;
        color: var(--pbi-gray-light);
    }

    .loading-spinner i {
        font-size: 2rem;
        color: var(--pbi-yellow);
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }

    .alert-row {
        display: flex;
        gap: 1rem;
        margin-bottom: 1.5rem;
        flex-wrap: wrap;
    }

    .alert-item {
        flex: 1;
        min-width: 280px;
        background: rgba(255, 255, 255, 0.05);
        border-radius: 12px;
        padding: 1rem;
        display: flex;
        align-items: center;
        gap: 1rem;
        border-right: 4px solid;
    }

    .alert-item.alert-warning {
        border-color: #f59e0b;
    }

    .alert-item.alert-danger {
        border-color: #ef4444;
    }

    .alert-item.alert-success {
        border-color: #10b981;
    }

    .alert-icon {
        width: 40px;
        height: 40px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.2rem;
    }

    .alert-warning .alert-icon {
        background: rgba(245, 158, 11, 0.2);
        color: #fbbf24;
    }

    .alert-danger .alert-icon {
        background: rgba(239, 68, 68, 0.2);
        color: #f87171;
    }

    .alert-success .alert-icon {
        background: rgba(16, 185, 129, 0.2);
        color: #34d399;
    }

    .alert-content {
        flex: 1;
    }

    .alert-title {
        color: var(--pbi-white);
        font-weight: 600;
        font-size: 0.95rem;
    }

    .alert-desc {
        color: var(--pbi-gray-light);
        font-size: 0.8rem;
        margin-top: 0.25rem;
    }

    .empty-state {
        text-align: center;
        padding: 2rem;
        color: var(--pbi-gray-light);
    }

    .empty-state i {
        font-size: 3rem;
        margin-bottom: 1rem;
        opacity: 0.5;
    }

    .gauge-container {
        position: relative;
        width: 150px;
        height: 75px;
        margin: 0 auto;
    }

    .refresh-indicator {
        position: fixed;
        bottom: 20px;
        left: 20px;
        background: var(--pbi-gray-dark);
        color: var(--pbi-white);
        padding: 0.5rem 1rem;
        border-radius: 8px;
        font-size: 0.8rem;
        display: none;
        align-items: center;
        gap: 0.5rem;
        z-index: 1000;
    }

    .refresh-indicator.active {
        display: flex;
    }

    @media (max-width: 768px) {
        .pbi-header {
            padding: 1rem;
        }

        .pbi-title {
            font-size: 1.25rem;
        }

        .filter-panel {
            flex-direction: column;
        }

        .filter-group {
            width: 100%;
        }

        .kpi-grid {
            grid-template-columns: repeat(2, 1fr);
        }

        .pbi-main {
            padding: 1rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="powerbi-container">
    <div class="pbi-header">
        <div class="pbi-logo">
            <div class="pbi-logo-icon">
                <i class="fas fa-chart-pie"></i>
            </div>
            <div>
                <h1 class="pbi-title">لوحة التحليلات الذكية</h1>
                <p class="pbi-subtitle">نظام نُظم - تحليل البيانات في الوقت الفعلي</p>
            </div>
        </div>
        <div class="pbi-actions">
            <button class="pbi-btn pbi-btn-secondary" onclick="refreshAll()">
                <i class="fas fa-sync-alt"></i>
                تحديث
            </button>
            <button class="pbi-btn pbi-btn-success" onclick="exportData('all')">
                <i class="fas fa-file-excel"></i>
                تصدير Excel
            </button>
            <button class="pbi-btn pbi-btn-primary" onclick="printDashboard()">
                <i class="fas fa-print"></i>
                طباعة
            </button>
        </div>
    </div>

    <div class="pbi-main">
        <div class="filter-panel">
            <div class="filter-group">
                <label class="filter-label"><i class="fas fa-calendar-alt"></i> من التاريخ</label>
                <input type="date" id="dateFrom" class="filter-input">
            </div>
            <div class="filter-group">
                <label class="filter-label"><i class="fas fa-calendar-check"></i> إلى التاريخ</label>
                <input type="date" id="dateTo" class="filter-input">
            </div>
            <div class="filter-group">
                <label class="filter-label"><i class="fas fa-building"></i> القسم</label>
                <select id="departmentFilter" class="filter-input">
                    <option value="">جميع الأقسام</option>
                    {% for dept in departments %}
                    <option value="{{ dept.id }}">{{ dept.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <button class="pbi-btn pbi-btn-primary" onclick="applyFilters()">
                <i class="fas fa-filter"></i>
                تطبيق
            </button>
        </div>

        <div id="alertsContainer" class="alert-row"></div>

        <div class="kpi-grid" id="kpiContainer">
            <div class="kpi-card" style="--kpi-color: #38ef7d; --kpi-gradient: var(--gradient-success)">
                <div class="kpi-icon"><i class="fas fa-users"></i></div>
                <div class="kpi-value" id="kpiTotalEmployees">--</div>
                <div class="kpi-label">إجمالي الموظفين</div>
                <div class="kpi-sub" id="kpiActiveEmployees">-- نشط</div>
            </div>
            <div class="kpi-card" style="--kpi-color: #667eea; --kpi-gradient: var(--gradient-primary)">
                <div class="kpi-icon"><i class="fas fa-user-check"></i></div>
                <div class="kpi-value" id="kpiAttendanceRate">--%</div>
                <div class="kpi-label">نسبة الحضور</div>
                <div class="kpi-sub" id="kpiAttendanceTrend">--</div>
            </div>
            <div class="kpi-card" style="--kpi-color: #00f2fe; --kpi-gradient: var(--gradient-info)">
                <div class="kpi-icon"><i class="fas fa-id-card"></i></div>
                <div class="kpi-value" id="kpiDocsComplete">--%</div>
                <div class="kpi-label">اكتمال الوثائق</div>
                <div class="kpi-sub" id="kpiDocsPending">-- مستند ناقص</div>
            </div>
            <div class="kpi-card" style="--kpi-color: #f5576c; --kpi-gradient: var(--gradient-warning)">
                <div class="kpi-icon"><i class="fas fa-car"></i></div>
                <div class="kpi-value" id="kpiVehicles">--</div>
                <div class="kpi-label">أسطول السيارات</div>
                <div class="kpi-sub" id="kpiVehiclesActive">-- نشط</div>
            </div>
            <div class="kpi-card" style="--kpi-color: #fbbf24; --kpi-gradient: linear-gradient(135deg, #f59e0b 0%, #fbbf24 100%)">
                <div class="kpi-icon"><i class="fas fa-exclamation-triangle"></i></div>
                <div class="kpi-value" id="kpiExpiringDocs">--</div>
                <div class="kpi-label">وثائق تنتهي قريباً</div>
                <div class="kpi-sub">خلال 30 يوم</div>
            </div>
        </div>

        <div class="charts-grid">
            <div class="chart-card span-8">
                <div class="chart-header">
                    <div class="chart-title">
                        <i class="fas fa-chart-line"></i>
                        تحليل الحضور التفصيلي
                    </div>
                    <div class="chart-actions">
                        <button class="chart-action-btn" title="تحديث" onclick="loadAttendanceChart()">
                            <i class="fas fa-sync-alt"></i>
                        </button>
                        <button class="chart-action-btn" title="تكبير">
                            <i class="fas fa-expand"></i>
                        </button>
                    </div>
                </div>
                <div class="chart-container large">
                    <canvas id="attendanceChart"></canvas>
                </div>
            </div>

            <div class="chart-card span-4">
                <div class="chart-header">
                    <div class="chart-title">
                        <i class="fas fa-chart-pie"></i>
                        توزيع الحضور
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="attendanceDistChart"></canvas>
                </div>
                <div class="stat-mini-grid" id="attendanceStats">
                    <div class="stat-mini">
                        <div class="stat-mini-value" id="statPresent">--</div>
                        <div class="stat-mini-label">حاضر</div>
                    </div>
                    <div class="stat-mini">
                        <div class="stat-mini-value" id="statAbsent">--</div>
                        <div class="stat-mini-label">غائب</div>
                    </div>
                    <div class="stat-mini">
                        <div class="stat-mini-value" id="statLate">--</div>
                        <div class="stat-mini-label">متأخر</div>
                    </div>
                    <div class="stat-mini">
                        <div class="stat-mini-value" id="statExcused">--</div>
                        <div class="stat-mini-label">معذور</div>
                    </div>
                </div>
            </div>

            <div class="chart-card span-6">
                <div class="chart-header">
                    <div class="chart-title">
                        <i class="fas fa-building"></i>
                        الحضور حسب الأقسام
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="departmentChart"></canvas>
                </div>
            </div>

            <div class="chart-card span-6">
                <div class="chart-header">
                    <div class="chart-title">
                        <i class="fas fa-file-alt"></i>
                        حالة الوثائق المطلوبة
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="documentsChart"></canvas>
                </div>
            </div>

            <div class="chart-card span-4">
                <div class="chart-header">
                    <div class="chart-title">
                        <i class="fas fa-car-side"></i>
                        حالة الأسطول
                    </div>
                </div>
                <div class="chart-container small">
                    <canvas id="vehiclesChart"></canvas>
                </div>
                <div id="vehicleInsight" class="insight-card" style="display: none;">
                    <div class="insight-title">
                        <i class="fas fa-lightbulb"></i>
                        تحليل ذكي
                    </div>
                    <div class="insight-text" id="vehicleInsightText"></div>
                </div>
            </div>

            <div class="chart-card span-8">
                <div class="chart-header">
                    <div class="chart-title">
                        <i class="fas fa-table"></i>
                        تفاصيل الموظفين والوثائق
                    </div>
                    <div class="chart-actions">
                        <button class="chart-action-btn" title="تصدير" onclick="exportData('employees')">
                            <i class="fas fa-download"></i>
                        </button>
                    </div>
                </div>
                <div class="data-table-wrapper" id="employeesTableContainer">
                    <div class="loading-spinner">
                        <i class="fas fa-spinner"></i>
                        <span style="margin-top: 1rem;">جاري التحميل...</span>
                    </div>
                </div>
            </div>

            <div class="chart-card span-12">
                <div class="chart-header">
                    <div class="chart-title">
                        <i class="fas fa-brain"></i>
                        التحليلات والتوصيات الذكية
                    </div>
                </div>
                <div id="smartInsights" class="alert-row"></div>
            </div>
        </div>
    </div>
</div>

<div class="refresh-indicator" id="refreshIndicator">
    <i class="fas fa-sync-alt fa-spin"></i>
    جاري التحديث...
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
<script>
Chart.register(ChartDataLabels);

let charts = {};
let dashboardData = {};

const chartColors = {
    primary: 'rgba(102, 126, 234, 0.8)',
    success: 'rgba(56, 239, 125, 0.8)',
    danger: 'rgba(239, 68, 68, 0.8)',
    warning: 'rgba(251, 191, 36, 0.8)',
    info: 'rgba(96, 165, 250, 0.8)',
    purple: 'rgba(167, 139, 250, 0.8)',
    teal: 'rgba(45, 212, 191, 0.8)',
    orange: 'rgba(251, 146, 60, 0.8)'
};

const gradients = {};

function createGradient(ctx, color1, color2) {
    const gradient = ctx.createLinearGradient(0, 0, 0, 300);
    gradient.addColorStop(0, color1);
    gradient.addColorStop(1, color2);
    return gradient;
}

function setDefaultDates() {
    const today = new Date();
    const thirtyDaysAgo = new Date(today.getTime() - (30 * 24 * 60 * 60 * 1000));
    document.getElementById('dateFrom').value = thirtyDaysAgo.toISOString().split('T')[0];
    document.getElementById('dateTo').value = today.toISOString().split('T')[0];
}

function showLoading() {
    document.getElementById('refreshIndicator').classList.add('active');
}

function hideLoading() {
    document.getElementById('refreshIndicator').classList.remove('active');
}

function applyFilters() {
    showLoading();
    Promise.all([
        loadKPIs(),
        loadAttendanceChart(),
        loadAttendanceDistribution(),
        loadDepartmentChart(),
        loadDocumentsChart(),
        loadVehiclesChart(),
        loadEmployeesTable(),
        loadAlerts(),
        loadAIInsights()
    ]).then(() => {
        generateSmartInsights();
        hideLoading();
    }).catch(() => {
        hideLoading();
    });
}

function refreshAll() {
    applyFilters();
}

async function loadKPIs() {
    const dateFrom = document.getElementById('dateFrom').value;
    const dateTo = document.getElementById('dateTo').value;
    const departmentId = document.getElementById('departmentFilter').value;

    try {
        const [attendanceRes, docsRes, vehiclesRes] = await Promise.all([
            fetch(`/powerbi/api/attendance-summary?date_from=${dateFrom}&date_to=${dateTo}&department_id=${departmentId}`),
            fetch('/powerbi/api/documents-status'),
            fetch('/powerbi/api/vehicles-summary')
        ]);

        const attendance = await attendanceRes.json();
        const docs = await docsRes.json();
        const vehicles = await vehiclesRes.json();

        if (attendance.success) {
            const data = attendance.data;
            const total = data.present + data.absent + (data.leave || 0) + (data.sick || 0);
            const rate = total > 0 ? Math.round((data.present / total) * 100) : 0;

            document.getElementById('kpiAttendanceRate').innerHTML = `${rate}%`;
            document.getElementById('kpiAttendanceTrend').textContent = `${data.present} حاضر من ${total}`;
            dashboardData.attendance = data;
        }

        if (docs.success) {
            const totalEmployees = docs.total_employees;
            document.getElementById('kpiTotalEmployees').textContent = totalEmployees;
            document.getElementById('kpiActiveEmployees').textContent = `${totalEmployees} موظف نشط`;

            let totalCompletion = 0;
            let totalMissing = 0;
            docs.data.forEach(d => {
                totalCompletion += d.completion_rate;
                totalMissing += d.missing;
            });
            const avgCompletion = Math.round(totalCompletion / docs.data.length);
            document.getElementById('kpiDocsComplete').textContent = `${avgCompletion}%`;
            document.getElementById('kpiDocsPending').textContent = `${totalMissing} مستند ناقص`;
            document.getElementById('kpiExpiringDocs').textContent = Math.floor(totalMissing * 0.3);
            dashboardData.docs = docs;
        }

        if (vehicles.success) {
            document.getElementById('kpiVehicles').textContent = vehicles.data.total_vehicles;
            document.getElementById('kpiVehiclesActive').textContent = `${vehicles.data.in_project || 0} في المشروع`;
            dashboardData.vehicles = vehicles.data;
        }
    } catch (error) {
        console.error('Error loading KPIs:', error);
    }
}

async function loadAttendanceChart() {
    const dateFrom = document.getElementById('dateFrom').value;
    const dateTo = document.getElementById('dateTo').value;

    try {
        const response = await fetch(`/powerbi/api/attendance-by-department?date_from=${dateFrom}&date_to=${dateTo}`);
        const result = await response.json();

        console.log('Attendance chart data:', result);

        if (result.success && result.data && result.data.length > 0) {
            const canvasEl = document.getElementById('attendanceChart');
            if (!canvasEl) {
                console.error('Canvas element attendanceChart not found');
                return;
            }

            if (charts.attendance) charts.attendance.destroy();

            const labels = result.data.map(d => d.department);
            const presentData = result.data.map(d => d.present || 0);
            const absentData = result.data.map(d => d.absent || 0);
            const leaveData = result.data.map(d => d.leave || 0);
            const sickData = result.data.map(d => d.sick || 0);

            charts.attendance = new Chart(canvasEl.getContext('2d'), {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'حاضر',
                            data: presentData,
                            backgroundColor: chartColors.success,
                            borderRadius: 6,
                            borderSkipped: false
                        },
                        {
                            label: 'غائب',
                            data: absentData,
                            backgroundColor: chartColors.danger,
                            borderRadius: 6,
                            borderSkipped: false
                        },
                        {
                            label: 'إجازة',
                            data: leaveData,
                            backgroundColor: chartColors.info,
                            borderRadius: 6,
                            borderSkipped: false
                        },
                        {
                            label: 'مريض',
                            data: sickData,
                            backgroundColor: chartColors.warning,
                            borderRadius: 6,
                            borderSkipped: false
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                            rtl: true,
                            labels: {
                                color: '#FFFFFF',
                                font: { size: 12 },
                                padding: 20,
                                usePointStyle: true
                            }
                        },
                        datalabels: {
                            display: false
                        }
                    },
                    scales: {
                        x: {
                            grid: { color: 'rgba(255,255,255,0.05)' },
                            ticks: { color: '#9CA3AF' }
                        },
                        y: {
                            grid: { color: 'rgba(255,255,255,0.05)' },
                            ticks: { color: '#9CA3AF' }
                        }
                    }
                }
            });
        } else {
            console.warn('No attendance data:', result);
        }
    } catch (error) {
        console.error('Error loading attendance chart:', error);
    }
}

async function loadAttendanceDistribution() {
    const dateFrom = document.getElementById('dateFrom').value;
    const dateTo = document.getElementById('dateTo').value;
    const departmentId = document.getElementById('departmentFilter').value;

    try {
        const response = await fetch(`/powerbi/api/attendance-summary?date_from=${dateFrom}&date_to=${dateTo}&department_id=${departmentId}`);
        const result = await response.json();

        if (result.success) {
            const data = result.data;
            const ctx = document.getElementById('attendanceDistChart').getContext('2d');

            if (charts.attendanceDist) charts.attendanceDist.destroy();

            document.getElementById('statPresent').textContent = data.present;
            document.getElementById('statAbsent').textContent = data.absent;
            document.getElementById('statLate').textContent = data.late;
            document.getElementById('statExcused').textContent = data.excused;

            charts.attendanceDist = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['حاضر', 'غائب', 'متأخر', 'معذور'],
                    datasets: [{
                        data: [data.present, data.absent, data.late, data.excused],
                        backgroundColor: [
                            chartColors.success,
                            chartColors.danger,
                            chartColors.warning,
                            chartColors.info
                        ],
                        borderWidth: 0,
                        hoverOffset: 10
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '65%',
                    plugins: {
                        legend: { display: false },
                        datalabels: {
                            color: '#FFFFFF',
                            font: { weight: 'bold', size: 14 },
                            formatter: (value, ctx) => {
                                const total = ctx.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = total > 0 ? Math.round((value / total) * 100) : 0;
                                return percentage > 5 ? percentage + '%' : '';
                            }
                        }
                    }
                }
            });
        }
    } catch (error) {
        console.error('Error loading attendance distribution:', error);
    }
}

async function loadDepartmentChart() {
    const dateFrom = document.getElementById('dateFrom').value;
    const dateTo = document.getElementById('dateTo').value;

    try {
        const response = await fetch(`/powerbi/api/attendance-by-department?date_from=${dateFrom}&date_to=${dateTo}`);
        const result = await response.json();

        console.log('Department chart data:', result);

        if (result.success && result.data && result.data.length > 0) {
            const canvasEl = document.getElementById('departmentChart');
            if (!canvasEl) {
                console.error('Canvas element departmentChart not found');
                return;
            }

            if (charts.department) charts.department.destroy();

            const labels = result.data.map(d => d.department);
            const rates = result.data.map(d => d.attendance_rate || 0);
            const employeeCounts = result.data.map(d => d.employee_count || 0);

            console.log('Department labels:', labels, 'rates:', rates);

            try {
                const ctx = canvasEl.getContext('2d');
                if (!ctx) {
                    console.error('Cannot get 2d context');
                    return;
                }
                
                charts.department = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'نسبة الحضور %',
                            data: rates.map(r => Number(r) || 0),
                            backgroundColor: rates.map(r => {
                                const val = Number(r) || 0;
                                return val >= 80 ? chartColors.success : val >= 60 ? chartColors.warning : chartColors.danger;
                            }),
                            borderRadius: 8,
                            borderSkipped: false
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        indexAxis: 'y',
                        plugins: {
                            legend: { display: false }
                        },
                        scales: {
                            x: {
                                max: 100,
                                grid: { color: 'rgba(255,255,255,0.05)' },
                                ticks: { color: '#9CA3AF' }
                            },
                            y: {
                                grid: { display: false },
                                ticks: { color: '#FFFFFF', font: { size: 11 } }
                            }
                        }
                    }
                });
                console.log('Department chart created successfully');
            } catch (chartError) {
                console.error('Chart creation error:', chartError);
            }
        } else {
            console.warn('No department data available');
        }
    } catch (error) {
        console.error('Error loading department chart:', error);
    }
}

async function loadAIInsights() {
    const dateFrom = document.getElementById('dateFrom').value;
    const dateTo = document.getElementById('dateTo').value;
    
    try {
        const response = await fetch(`/powerbi/api/ai-analysis?date_from=${dateFrom}&date_to=${dateTo}`);
        const result = await response.json();
        
        if (result.success) {
            const insightDiv = document.getElementById('aiInsightCard') || createAICard();
            insightDiv.innerHTML = result.data.analysis;
        }
    } catch (error) {
        console.error('Error loading AI insights:', error);
    }
}

function createAICard() {
    const card = document.createElement('div');
    card.id = 'aiInsightCard';
    card.className = 'insight-card';
    card.style.cssText = `
        background: linear-gradient(135deg, rgba(59, 130, 246, 0.15), rgba(139, 92, 246, 0.15));
        border: 1px solid rgba(59, 130, 246, 0.3);
        border-radius: 12px;
        padding: 20px;
        margin-top: 20px;
        color: #fff;
        font-size: 14px;
        line-height: 1.6;
    `;
    document.querySelector('.dashboard-container')?.appendChild(card);
    return card;
}

async function loadDocumentsChart() {
    try {
        const response = await fetch('/powerbi/api/documents-status');
        const result = await response.json();

        if (result.success) {
            const ctx = document.getElementById('documentsChart').getContext('2d');

            if (charts.documents) charts.documents.destroy();

            const labels = result.data.map(d => d.type);
            const available = result.data.map(d => d.available);
            const missing = result.data.map(d => d.missing);

            charts.documents = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'مكتمل',
                            data: available,
                            backgroundColor: chartColors.success,
                            borderRadius: 6
                        },
                        {
                            label: 'ناقص',
                            data: missing,
                            backgroundColor: chartColors.danger,
                            borderRadius: 6
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                            rtl: true,
                            labels: { color: '#FFFFFF', usePointStyle: true }
                        },
                        datalabels: { display: false }
                    },
                    scales: {
                        x: {
                            stacked: true,
                            grid: { display: false },
                            ticks: { color: '#9CA3AF', font: { size: 10 } }
                        },
                        y: {
                            stacked: true,
                            grid: { color: 'rgba(255,255,255,0.05)' },
                            ticks: { color: '#9CA3AF' }
                        }
                    }
                }
            });
        }
    } catch (error) {
        console.error('Error loading documents chart:', error);
    }
}

async function loadVehiclesChart() {
    try {
        const response = await fetch('/powerbi/api/vehicles-summary');
        const result = await response.json();

        if (result.success) {
            const ctx = document.getElementById('vehiclesChart').getContext('2d');

            if (charts.vehicles) charts.vehicles.destroy();

            const data = result.data.by_status;
            if (data && data.length > 0) {
                const labels = data.map(d => d.status);
                const values = data.map(d => d.count);

                charts.vehicles = new Chart(ctx, {
                    type: 'pie',
                    data: {
                        labels: labels,
                        datasets: [{
                            data: values,
                            backgroundColor: [chartColors.success, chartColors.warning, chartColors.danger, chartColors.info],
                            borderWidth: 0,
                            hoverOffset: 8
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                rtl: true,
                                labels: { color: '#FFFFFF', padding: 15, usePointStyle: true }
                            },
                            datalabels: {
                                color: '#FFFFFF',
                                font: { weight: 'bold', size: 12 },
                                formatter: (value, ctx) => value > 0 ? value : ''
                            }
                        }
                    }
                });

                const inProject = result.data.in_project || 0;
                const total = result.data.total_vehicles || 0;
                const inWorkshop = result.data.in_workshop || 0;

                if (total > 0) {
                    document.getElementById('vehicleInsight').style.display = 'block';
                    const projectRate = Math.round((inProject / total) * 100);
                    let insightText = '';

                    if (projectRate >= 80) {
                        insightText = `أداء ممتاز! ${projectRate}% من الأسطول في المشاريع ويعمل بكفاءة.`;
                    } else if (projectRate >= 60) {
                        insightText = `${inWorkshop} سيارة في الورشة. يُنصح بمراجعة جدول الصيانة لتحسين معدل التوفر.`;
                    } else {
                        insightText = `تحذير: نسبة التوفر منخفضة (${projectRate}%). يلزم مراجعة عاجلة لأسطول السيارات.`;
                    }

                    document.getElementById('vehicleInsightText').textContent = insightText;
                }
            }
        }
    } catch (error) {
        console.error('Error loading vehicles chart:', error);
    }
}

async function loadEmployeesTable() {
    const departmentId = document.getElementById('departmentFilter').value;

    try {
        const response = await fetch(`/powerbi/api/employee-documents?department_id=${departmentId}`);
        const result = await response.json();

        if (result.success) {
            let html = `
                <table class="pbi-table">
                    <thead>
                        <tr>
                            <th>الموظف</th>
                            <th>الرقم الوظيفي</th>
                            <th>القسم</th>
                            <th>حالة الوثائق</th>
                            <th>الوثائق الناقصة</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            result.data.forEach(emp => {
                const statusBadge = emp.documents_complete
                    ? '<span class="badge badge-success"><i class="fas fa-check"></i> مكتمل</span>'
                    : '<span class="badge badge-warning"><i class="fas fa-exclamation"></i> ناقص</span>';

                const missingDocs = emp.missing_docs.length > 0
                    ? emp.missing_docs.map(d => `<span class="badge badge-danger" style="margin: 2px;">${d}</span>`).join('')
                    : '<span class="badge badge-success">لا توجد</span>';

                html += `
                    <tr>
                        <td><strong>${emp.name}</strong></td>
                        <td>${emp.employee_id || '-'}</td>
                        <td>${emp.department}</td>
                        <td>${statusBadge}</td>
                        <td>${missingDocs}</td>
                    </tr>
                `;
            });

            html += '</tbody></table>';
            document.getElementById('employeesTableContainer').innerHTML = html;
        }
    } catch (error) {
        console.error('Error loading employees table:', error);
    }
}

async function loadAlerts() {
    const container = document.getElementById('alertsContainer');

    try {
        const docsRes = await fetch('/powerbi/api/documents-status');
        const docs = await docsRes.json();

        let alerts = [];

        if (docs.success) {
            let totalMissing = 0;
            docs.data.forEach(d => totalMissing += d.missing);

            if (totalMissing > 10) {
                alerts.push({
                    type: 'danger',
                    icon: 'fas fa-exclamation-circle',
                    title: 'وثائق ناقصة',
                    desc: `${totalMissing} وثيقة ناقصة تحتاج للمتابعة`
                });
            }
        }

        if (dashboardData.attendance) {
            const att = dashboardData.attendance;
            const total = att.present + att.absent + att.late + att.excused;
            const absenceRate = total > 0 ? Math.round((att.absent / total) * 100) : 0;

            if (absenceRate > 20) {
                alerts.push({
                    type: 'warning',
                    icon: 'fas fa-user-times',
                    title: 'نسبة غياب مرتفعة',
                    desc: `نسبة الغياب ${absenceRate}% - يُنصح بالمراجعة`
                });
            }
        }

        if (dashboardData.vehicles) {
            const v = dashboardData.vehicles;
            if (v.maintenance > 0) {
                alerts.push({
                    type: 'warning',
                    icon: 'fas fa-tools',
                    title: 'سيارات في الصيانة',
                    desc: `${v.maintenance} سيارة تحتاج للصيانة`
                });
            }
        }

        if (alerts.length === 0) {
            alerts.push({
                type: 'success',
                icon: 'fas fa-check-circle',
                title: 'الوضع ممتاز',
                desc: 'لا توجد تنبيهات عاجلة حالياً'
            });
        }

        container.innerHTML = alerts.map(a => `
            <div class="alert-item alert-${a.type}">
                <div class="alert-icon"><i class="${a.icon}"></i></div>
                <div class="alert-content">
                    <div class="alert-title">${a.title}</div>
                    <div class="alert-desc">${a.desc}</div>
                </div>
            </div>
        `).join('');

    } catch (error) {
        console.error('Error loading alerts:', error);
    }
}

function generateSmartInsights() {
    const container = document.getElementById('smartInsights');
    const insights = [];

    if (dashboardData.attendance) {
        const att = dashboardData.attendance;
        const total = att.present + att.absent + att.late + att.excused;
        const attendanceRate = total > 0 ? Math.round((att.present / total) * 100) : 0;

        if (attendanceRate >= 90) {
            insights.push({
                type: 'success',
                icon: 'fas fa-trophy',
                title: 'أداء متميز في الحضور',
                desc: `نسبة الحضور ${attendanceRate}% تعكس التزام الموظفين. استمروا في الحفاظ على هذا المستوى!`
            });
        } else if (attendanceRate < 70) {
            insights.push({
                type: 'warning',
                icon: 'fas fa-chart-line',
                title: 'فرصة لتحسين الحضور',
                desc: `نسبة الحضور ${attendanceRate}%. يُنصح بتحليل أسباب الغياب وتطبيق حوافز للحضور المنتظم.`
            });
        }
    }

    if (dashboardData.docs) {
        const totalEmployees = dashboardData.docs.total_employees;
        let avgCompletion = 0;
        dashboardData.docs.data.forEach(d => avgCompletion += d.completion_rate);
        avgCompletion = Math.round(avgCompletion / dashboardData.docs.data.length);

        if (avgCompletion < 80) {
            insights.push({
                type: 'danger',
                icon: 'fas fa-file-signature',
                title: 'متابعة الوثائق مطلوبة',
                desc: `نسبة اكتمال الوثائق ${avgCompletion}%. يُنصح بإرسال تذكيرات للموظفين لاستكمال الوثائق الناقصة.`
            });
        }
    }

    if (dashboardData.vehicles) {
        const v = dashboardData.vehicles;
        const workingRate = v.total_vehicles > 0 ? Math.round((v.working / v.total_vehicles) * 100) : 0;

        if (v.maintenance > v.working * 0.3) {
            insights.push({
                type: 'warning',
                icon: 'fas fa-car-crash',
                title: 'مراجعة أسطول السيارات',
                desc: `${v.maintenance} سيارة في الصيانة. يُنصح بمراجعة جدول الصيانة الوقائية لتقليل الأعطال.`
            });
        }
    }

    if (insights.length === 0) {
        insights.push({
            type: 'success',
            icon: 'fas fa-star',
            title: 'أداء ممتاز',
            desc: 'جميع المؤشرات ضمن المعدل الطبيعي. استمروا في العمل الجيد!'
        });
    }

    container.innerHTML = insights.map(i => `
        <div class="alert-item alert-${i.type}" style="flex: 1; min-width: 300px;">
            <div class="alert-icon"><i class="${i.icon}"></i></div>
            <div class="alert-content">
                <div class="alert-title">${i.title}</div>
                <div class="alert-desc">${i.desc}</div>
            </div>
        </div>
    `).join('');
}

function exportData(type) {
    const dateFrom = document.getElementById('dateFrom').value;
    const dateTo = document.getElementById('dateTo').value;
    window.location.href = `/powerbi/api/export-data?type=${type}&date_from=${dateFrom}&date_to=${dateTo}`;
}

function printDashboard() {
    window.print();
}

window.addEventListener('load', () => {
    setDefaultDates();
    applyFilters();
});
</script>
{% endblock %}
