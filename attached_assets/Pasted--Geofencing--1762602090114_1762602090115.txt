خطة تطوير ميزة الدوائر الجغرافية (Geofencing)
الفكرة الأساسية
الدوائر الجغرافية هي مناطق افتراضية مرتبطة بقسم معين يتم رسمها على الخريطة. يمكن معرفة موظفي القسم داخل الدائرة ومن هو خارجها، مع إمكانية تسجيل حضور جماعي فقط لموظفي القسم المرتبط بضغطة زر واحدة.

القاعدة الأساسية
الدائرة مرتبطة بقسم واحد فقط ← يتم تسجيل الحضور فقط لموظفي هذا القسم الموجودين داخل الدائرة.

أمثلة عملية
مثال 1: دائرة مشروع برج المملكة
مرتبطة بقسم: الهندسة
الموقع: الرياض - حي العليا
نصف القطر: 500 متر
الموظفين المؤهلين للحضور: فقط موظفو قسم الهندسة
السيناريو:
الموظفين داخل الدائرة:

أحمد محمد (قسم: الهندسة) ← سيُسجل حضوره
خالد علي (قسم: الهندسة) ← سيُسجل حضوره
فهد سعد (قسم: المبيعات) ← لن يُسجل حضوره (قسم مختلف)
سعد أحمد (قسم: المحاسبة) ← لن يُسجل حضوره (قسم مختلف)
مثال 2: دائرة المكتب الرئيسي
مرتبطة بقسم: الإدارة
الموقع: الرياض - العليا
نصف القطر: 200 متر
الموظفين المؤهلين: فقط موظفو قسم الإدارة
مثال 3: دائرة المستودع الشمالي
مرتبطة بقسم: اللوجستيات
الموقع: الرياض - الشمال
نصف القطر: 300 متر
الموظفين المؤهلين: فقط موظفو قسم اللوجستيات
الميزات المطلوبة
1. إنشاء وإدارة الدوائر
عند إنشاء دائرة جديدة:

اسم الدائرة (إلزامي)
النوع: مشروع / مكتب / مستودع
القسم المرتبط (إلزامي - لا يمكن تركه فارغاً)
الموقع على الخريطة (انقر لتحديد)
نصف القطر بالأمتار (50 - 10000 متر)
اللون (للتمييز على الخريطة)
ملاحظة مهمة: لا يمكن إنشاء دائرة بدون ربطها بقسم.

2. الكشف التلقائي (حسب القسم)
النظام يعرض فقط موظفي القسم المرتبط مع حالتهم:

داخل الدائرة (أخضر) - موظف من القسم وداخل النطاق
خارج الدائرة (أصفر) - موظف من القسم لكن خارج النطاق
موظفو أقسام أخرى - يتم إخفاؤهم أو عرضهم بلون رمادي للمعلومة فقط
3. سجل الأحداث
تسجيل دخول/خروج لجميع الموظفين (بغض النظر عن القسم) للتتبع فقط
لكن تسجيل الحضور فقط لموظفي القسم المرتبط
4. زر تسجيل الحضور الجماعي (الميزة الرئيسية)
الواجهة المتوقعة:

عرض اسم الدائرة والقسم المرتبط ونصف القطر
عرض عدد موظفي القسم داخل الدائرة
زر كبير: "تسجيل حضور جماعي (5 موظفين)"
قائمة الموظفين المؤهلين (من القسم فقط) مع المسافة
قائمة الموظفين الآخرين (من أقسام أخرى) مع علامة أنهم لن يُسجل حضورهم
عند الضغط على الزر:

يتم تسجيل حضور فقط لموظفي القسم المرتبط الموجودين داخل الدائرة
لا يتم تسجيل حضور للموظفين من أقسام أخرى (حتى لو كانوا داخل الدائرة)
يظهر إشعار: "تم تسجيل حضور 5 موظفين من قسم الهندسة"
يتم تخطي من سجل حضوره مسبقاً اليوم
5. الإشعارات (اختيارية)
إشعار عند دخول/خروج موظف من القسم المرتبط
تقرير يومي بحركة موظفي القسم
تنبيه للتأخير لموظفي القسم
6. عرض صورة القمر الصناعي
زر لتبديل بين الخريطة العادية وصورة القمر الصناعي
استخدام Mapbox Satellite للوضوح
7. نسخ رابط الموقع للمشاركة
إنشاء رابط مؤقت لمشاركة موقع الدائرة
ينتهي بعد 24 ساعة للأمان
8. عرض صور الموظفين على الخريطة
صورة دائرية صغيرة 64×64 بكسل
تمييز موظفي القسم المرتبط بلون مختلف
صورة افتراضية للموظفين بدون صور
البنية التقنية
قاعدة البيانات
جدولين فقط (تم تبسيط التصميم):

جدول 1: geofences (الدوائر)

id: معرف تلقائي
name: اسم الدائرة (نص 200 حرف، إلزامي)
type: نوع الدائرة (project, office, warehouse, other)
description: وصف (نص طويل، اختياري)
center_latitude: خط العرض للمركز (رقم 9,6، إلزامي)
center_longitude: خط الطول للمركز (رقم 9,6، إلزامي)
radius_meters: نصف القطر بالأمتار (رقم صحيح، إلزامي)
color: لون الدائرة (نص 20 حرف، افتراضي #667eea)
is_active: هل الدائرة نشطة (صح/خطأ، افتراضي صح)
department_id: معرف القسم (رقم، إلزامي، مرتبط بجدول الأقسام)
notify_on_entry: إشعار عند الدخول (صح/خطأ، افتراضي خطأ)
notify_on_exit: إشعار عند الخروج (صح/خطأ، افتراضي خطأ)
created_by: من أنشأها (معرف المستخدم)
created_at: تاريخ الإنشاء
updated_at: تاريخ آخر تحديث
قيود:

نصف القطر بين 0 و 10000 متر
النوع من القائمة المحددة فقط
department_id لا يمكن أن يكون فارغاً (NOT NULL)
عند حذف القسم، تُحذف الدوائر المرتبطة به (CASCADE)
فهارس للأداء:

فهرس على (department_id, is_active)
جدول 2: geofence_events (سجل الأحداث)

id: معرف تلقائي
geofence_id: معرف الدائرة (مرتبط بجدول الدوائر)
employee_id: معرف الموظف (مرتبط بجدول الموظفين)
event_type: نوع الحدث (enter, exit, bulk_check_in)
location_latitude: خط العرض للموقع (رقم 9,6)
location_longitude: خط الطول للموقع (رقم 9,6)
distance_from_center: المسافة من المركز بالأمتار (رقم صحيح)
recorded_at: وقت الحدث
processed_at: وقت المعالجة
source: مصدر الحدث (auto, bulk)
attendance_id: معرف سجل الحضور (مرتبط بجدول الحضور)
notes: ملاحظات (نص طويل)
قيود:

نوع الحدث من القائمة المحددة فقط
فهارس للأداء:

فهرس على (recorded_at DESC)
فهرس على (employee_id, recorded_at DESC)
فهرس على (geofence_id, recorded_at DESC)
التنفيذ في Flask
Model الدائرة:

class Geofence(db.Model):
    # الحقول الأساسية
    id = معرف تلقائي
    name = نص 200 حرف
    type = نص 50 حرف
    department_id = معرف القسم (إلزامي، NOT NULL)
    center_latitude = رقم 9,6
    center_longitude = رقم 9,6
    radius_meters = رقم صحيح
    color = نص 20 حرف
    is_active = صح/خطأ
    
    # العلاقات
    department = علاقة مع جدول الأقسام
    events = علاقة مع جدول الأحداث
    
    # دالة: جلب موظفي القسم المرتبط داخل الدائرة فقط
    def get_department_employees_inside(self):
        # البحث عن موظفي القسم المرتبط فقط
        # التحقق من وجودهم داخل نطاق الدائرة
        # إرجاع قائمة بهم مع المواقع والمسافات
    
    # دالة: جلب جميع الموظفين داخل الدائرة (للعرض فقط)
    def get_all_employees_inside(self):
        # البحث عن جميع الموظفين
        # التحقق من وجودهم داخل الدائرة
        # تحديد من هو مؤهل (من القسم المرتبط) ومن لا
        # إرجاع القائمة الكاملة
    
    # دالة: حساب المسافة باستخدام Haversine formula
    def calculate_distance(self, lat, lon):
        # حساب المسافة من مركز الدائرة
        # إرجاع المسافة بالأمتار

Model الأحداث:

class GeofenceEvent(db.Model):
    # الحقول
    id = معرف تلقائي
    geofence_id = معرف الدائرة
    employee_id = معرف الموظف
    event_type = نوع الحدث
    location_latitude = خط العرض
    location_longitude = خط الطول
    distance_from_center = المسافة
    recorded_at = وقت التسجيل
    source = المصدر
    attendance_id = معرف الحضور
    notes = ملاحظات
    
    # العلاقات
    employee = علاقة مع جدول الموظفين
    geofence = علاقة مع جدول الدوائر

Route تسجيل الحضور الجماعي:

مسار: /geofences/<id>/bulk-check-in
الطريقة: POST
يحتاج تسجيل دخول: نعم
الخطوات:
1. جلب الدائرة حسب المعرف
2. جلب موظفي القسم المرتبط داخل الدائرة فقط
3. إذا لم يوجد موظفين: إرجاع رسالة خطأ
4. لكل موظف:
   - التحقق من عدم تسجيل حضوره اليوم
   - إذا لم يُسجل: تسجيل حضور جديد
   - تسجيل حدث bulk_check_in
   - إضافة الاسم لقائمة المسجلين
5. حفظ التغييرات في قاعدة البيانات
6. إرجاع النتيجة:
   - عدد المسجلين
   - عدد المسجلين مسبقاً
   - قائمة الأسماء
   - رسالة نجاح

خطة التنفيذ (4 مراحل)
المرحلة 1: البنية الأساسية (أسبوع 1)
المهام:

 إنشاء جدول geofences في قاعدة البيانات مع department_id إلزامي
 إنشاء جدول geofence_events
 إضافة الفهارس المطلوبة
 إنشاء Model للدائرة (Geofence) في Flask
 إنشاء Model للأحداث (GeofenceEvent)
 إنشاء ملف Routes للدوائر
 إنشاء Routes أساسية (قائمة، عرض، إنشاء، تعديل، حذف)
المرحلة 2: المعالجة التلقائية (أسبوع 2)
المهام:

 كتابة دالة حساب المسافة (Haversine formula)
 كتابة دالة الكشف عن الموظفين داخل الدائرة
 إضافة معالج تلقائي عند استلام موقع جديد:
كشف دخول الموظف لدائرة
كشف خروج الموظف من دائرة
تسجيل الأحداث تلقائياً
 إنشاء Route لجلب الأحداث التاريخية
 اختبار المعالجة التلقائية
المرحلة 3: الواجهة والخريطة (أسبوع 3)
المهام:

 إنشاء صفحة إدارة الدوائر (/employees/geofences)
 نموذج إنشاء دائرة جديدة (مع اختيار القسم إلزامياً)
 رسم الدوائر على الخريطة باستخدام Leaflet.js
 عرض موظفي القسم داخل/خارج الدائرة
 زر تسجيل الحضور الجماعي مع API endpoint
 عرض صور الموظفين على الخريطة (thumbnails 64×64)
 زر تبديل صورة القمر الصناعي (Mapbox Satellite)
 تحديث صفحة التتبع لعرض الدوائر
 إضافة تمييز بصري لموظفي القسم المرتبط
المرحلة 4: الميزات الإضافية (أسبوع 4)
المهام:

 إنشاء روابط مشاركة مؤقتة (24 ساعة)
 صفحة خريطة عامة للروابط المشاركة
 الإشعارات عند الدخول/الخروج (اختيارية)
 تقرير يومي بحركة موظفي القسم
 صفحة إحصائيات وتقارير:
كم ساعة قضى كل موظف داخل الدائرة
عدد مرات الزيارة
معدل التأخير
 سجل الدخول والخروج التاريخي
 اختبار شامل لجميع الميزات
الفروقات الأساسية عن التصاميم السابقة
ما تم تغييره:
النسخة السابقة:

ربط الدائرة بقسم: اختياري (nullable)
تسجيل الحضور: لجميع من في الدائرة
عرض الموظفين: جميع من في الدائرة بدون تمييز
عدد الجداول: 3 (geofences, geofence_membership, geofence_events)
النسخة الحالية:

ربط الدائرة بقسم: إلزامي (NOT NULL)
تسجيل الحضور: فقط لموظفي القسم المرتبط
عرض الموظفين: تمييز واضح بين موظفي القسم والآخرين
عدد الجداول: 2 فقط (geofences, geofence_events) - أبسط
الفائدة:
تحكم أفضل: كل دائرة خاصة بقسم واحد
وضوح أكبر: لا يوجد لبس في من يُسجل حضوره
بنية أبسط: لا حاجة لجدول geofence_membership
أمان أعلى: لا يمكن تسجيل حضور لموظف من قسم خاطئ
سهولة الصيانة: جداول أقل = كود أقل = أخطاء أقل
ملاحظات مهمة
الأداء:
استخدام Cache لمراكز الدوائر لتسريع الحسابات
حساب المسافات فقط عند الحاجة
تجميع علامات الموظفين على الخريطة (Clustering)
تحديث المواقع كل 5 دقائق (موجود بالفعل)
الأمان والخصوصية:
موافقة الموظف على التتبع
تشفير البيانات الحساسة
حذف البيانات القديمة بعد 6 أشهر
روابط المشاركة تنتهي بعد 24 ساعة
حماية صفحات الإدارة (مديرين فقط)
الدقة:
الأخذ بعين الاعتبار دقة GPS (accuracy)
تجاهل المواقع ذات دقة أقل من 50 متر
إضافة هامش خطأ ±10 أمتار للدوائر
تاريخ التحديث: 08 نوفمبر 2025
الإصدار: 3.0 (ربط صارم بالأقسام)
الحالة: جاهز للتنفيذ

هل أبدأ بالتنفيذ الآن؟