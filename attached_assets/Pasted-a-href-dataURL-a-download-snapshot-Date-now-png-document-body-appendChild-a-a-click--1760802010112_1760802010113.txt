a.href = dataURL; a.download = `snapshot-${Date.now()}.png`; document.body.appendChild(a); a.click(); document.body.removeChild(a); } function addThumbnail(dataURL) { const img = document.createElement('img'); img.src = dataURL; img.alt = 'Captured snapshot'; img.style.maxWidth = '160px'; img.style.margin = '4px'; galleryEl.appendChild(img); } // Example upload: send base64 payload to server function uploadImage(dataURL) { // Strip "data:image/png;base64," prefix const base64 = dataURL.split(',')[1]; fetch('/upload-snapshot', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ filename: `snapshot-${Date.now()}.png`, image_base64: base64 }) }) .then(r => { if (!r.ok) throw new Error('Upload failed'); return r.json(); }) .then(result => { console.log('Uploaded:', result); }) .catch(err => { console.error(err); alert('Upload error: ' + err.message); }); } // التحقق من الموظف async function verifyEmployee() { const nationalId = document.getElementById('driver_national_id').value; if (!nationalId) { alert('يرجى إدخال رقم الهوية الوطنية'); return; } // إضافة مؤشر التحميل const submitBtn = document.getElementById('submitBtn'); const originalText = submitBtn.innerHTML; submitBtn.innerHTML = ' جاري التحقق...'; submitBtn.disabled = true; try { console.log('Verifying employee with ID:', nationalId); const response = await fetch(`/external-safety/api/verify-employee/${nationalId}`, { method: 'GET', headers: { 'Content-Type': 'application/json', } }); console.log('Response status:', response.status); const data = await response.json(); console.log('Response data:', data); if (response.ok && data.success) { // تعبئة البيانات التلقائية document.getElementById('driver_name').value = data.employee.name; document.getElementById('driver_department').value = data.employee.department; document.getElementById('driver_city').value = data.employee.city || 'الرياض'; // عرض معلومات التحقق const verification = document.getElementById('employeeVerification'); const details = document.getElementById('employeeDetails'); details.innerHTML = `
الاسم: ${data.employee.name}
القسم: ${data.employee.department}
المدينة: ${data.employee.city || 'الرياض'}
`; verification.style.display = 'block'; // إظهار رسالة نجاح showAlert('تم التحقق من الموظف بنجاح', 'success'); } else { // إخفاء معلومات التحقق const verification = document.getElementById('employeeVerification'); verification.style.display = 'none'; // مسح البيانات المعبأة document.getElementById('driver_name').value = ''; document.getElementById('driver_department').value = ''; document.getElementById('driver_city').value = ''; showAlert('لم يتم العثور على موظف بهذا الرقم', 'danger'); } } catch (error) { console.error('خطأ في التحقق من الموظف:', error); showAlert('حدث خطأ في التحقق من الموظف. يرجى المحاولة مرة أخرى.', 'danger'); // إخفاء معلومات التحقق const verification = document.getElementById('employeeVerification'); verification.style.display = 'none'; } finally { // إعادة الزر لحالته الطبيعية submitBtn.innerHTML = originalText; submitBtn.disabled = false; } } // دالة لعرض التنبيهات function showAlert(message, type) { const alertDiv = document.createElement('div'); alertDiv.className = `alert alert-${type} alert-dismissible fade show`; alertDiv.innerHTML = ` ${message}  `; const container = document.querySelector('.form-container'); container.insertBefore(alertDiv, container.firstChild); // إخفاء التنبيه تلقائياً بعد 5 ثوان setTimeout(() => { alertDiv.remove(); }, 5000); } // معالجة رفع الصور function handleImageUpload(input) { const files = input.files; for (let i = 0; i < files.length; i++) { const file = files[i]; if (file.type.startsWith('image/')) { const reader = new FileReader(); reader.onload = function(e) { const imageData = { file: file, src: e.target.result, id: Date.now() + i }; uploadedImages.push(imageData); displayImagePreview(); }; reader.readAsDataURL(file); } } } // عرض معاينة الصور function displayImagePreview() { // const preview = document.getElementById('imagePreview'); // preview.innerHTML = ''; // uploadedImages.forEach((image, index) => { // const item = document.createElement('div'); // item.className = 'image-preview-item'; // // إنشاء حاوية الصورة // const imageContainer = document.createElement('div'); // imageContainer.className = 'image-container'; // // إنشاء عنصر الصورة // const img = document.createElement('img'); // img.src = image.src; // img.alt = `صورة ${index + 1}`; // // إنشاء زر الحذف // const removeBtn = document.createElement('button'); // removeBtn.type = 'button'; // removeBtn.className = 'remove-btn'; // removeBtn.innerHTML = ''; // removeBtn.onclick = () => removeImage(image.id); // // إضافة الصورة وزر الحذف لحاوية الصورة // imageContainer.appendChild(img); // imageContainer.appendChild(removeBtn); // // إنشاء حقل الوصف // const descInput = document.createElement('input'); // descInput.type = 'text'; // descInput.className = 'description-input'; // descInput.placeholder = `وصف الصورة ${index + 1} (اختياري)`; // descInput.name = 'image_descriptions'; // descInput.value = image.description || ''; // descInput.style.display = 'block'; // descInput.style.width = '100%'; // descInput.style.maxWidth = '100%'; // descInput.style.boxSizing = 'border-box'; // descInput.style.marginTop = '15px'; // descInput.style.marginBottom = '15px'; // descInput.style.padding = '15px'; // descInput.style.border = '2px solid #667eea'; // descInput.style.borderRadius = '8px'; // descInput.style.fontSize = '1.1rem'; // descInput.style.backgroundColor = 'white'; // descInput.style.color = '#333'; // descInput.style.minHeight = '55px'; // descInput.style.outline = 'none'; // descInput.style.fontFamily = 'Cairo, sans-serif'; // descInput.style.visibility = 'visible'; // descInput.style.opacity = '1'; // descInput.onchange = (e) => updateImageDescription(image.id, e.target.value); // descInput.oninput = (e) => updateImageDescription(image.id, e.target.value); // // إضافة العناصر للحاوية الرئيسية // item.appendChild(imageContainer); // item.appendChild(descInput); // preview.appendChild(item); galleryEl.innerHTML = ''; uploadedImages.forEach(image => { const container = document.createElement('div'); container.style.margin = '6px'; container.style.display = 'inline-block'; container.style.textAlign = 'center'; const img = document.createElement('img'); img.src = image.src; img.style.maxWidth = '160px'; img.style.display = 'block'; img.style.marginBottom = '4px'; img.alt = 'Captured image'; const caption = document.createElement('p'); caption.textContent = image.note; caption.style.fontSize = '0.9em'; caption.style.color = '#555'; container.appendChild(img); container.appendChild(caption); galleryEl.appendChild(container); }); } // حذف صورة function removeImage(imageId) { uploadedImages = uploadedImages.filter(img => img.id !== imageId); displayImagePreview(); } // تحديث وصف الصورة function updateImageDescription(imageId, description) { const image = uploadedImages.find(img => img.id === imageId); if (image) { image.description = description; } } // إعداد السحب والإفلات const uploadArea = document.querySelector('.image-upload-area'); uploadArea.addEventListener('dragover', (e) => { e.preventDefault(); uploadArea.classList.add('dragover'); }); uploadArea.addEventListener('dragleave', (e) => { e.preventDefault(); uploadArea.classList.remove('dragover'); }); uploadArea.addEventListener('drop', (e) => { e.preventDefault(); uploadArea.classList.remove('dragover'); const files = e.dataTransfer.files; const input = document.getElementById('safety_images'); input.files = files; handleImageUpload(input); }); // إرسال النموذج document.getElementById('safetyForm').addEventListener('submit', async (e) => { e.preventDefault(); const formData = new FormData(); const form = e.target; // إضافة البيانات النصية for (let input of form.elements) { if (input.type !== 'file' && input.name) { formData.append(input.name, input.value); } } // إضافة الصور مع أوصافها uploadedImages.forEach((image, index) => { formData.append(`safety_images`, image.file); formData.append(`image_descriptions`, image.description || ''); }); // تسجيل تفصيلي للتشخيص console.log('عدد الصور المرفوعة:', uploadedImages.length); console.log('البيانات المرسلة:', Object.fromEntries(formData.entries())); const submitBtn = document.getElementById('submitBtn'); const loadingSpinner = document.getElementById('loadingSpinner'); submitBtn.disabled = true; loadingSpinner.style.display = 'block'; try { console.log('بدء إرسال النموذج...'); const response = await fetch(window.location.pathname, { method: 'POST', body: formData }); console.log('تم استلام الاستجابة:', response.status, response.statusText); if (response.ok) { // إظهار رسالة نجاح مباشرة وإخفاء النموذج document.querySelector('.form-container').innerHTML = `
تم إرسال الطلب بنجاح!
تم إرسال طلب فحص السلامة بنجاح وسيتم مراجعته من قبل المسؤول المختص.

 سيتم مراجعة طلبك خلال 24 ساعة كحد أقصى.
`; // إضافة تأثير الـ pulse animation const style = document.createElement('style'); style.textContent = ` @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } } `; document.head.appendChild(style); // إغلاق النافذة تلقائياً بعد 10 ثوان setTimeout(() => { window.close(); }, 10000); } else { const errorData = await response.json(); alert('حدث خطأ: ' + (errorData.error || 'خطأ غير معروف')); submitBtn.disabled = false; loadingSpinner.style.display = 'none'; } } catch (error) { console.error('خطأ في إرسال النموذج:', error); alert('حدث خطأ في الاتصال بالخادم. يرجى المحاولة مرة أخرى.'); submitBtn.disabled = false; loadingSpinner.style.display = 'none'; } });