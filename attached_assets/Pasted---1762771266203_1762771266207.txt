 الطلبات لا تطابق ما يتوقعه السيرفر، خصوصاً في طلب الغسيل. أما الفاتورة فلدينا مسارين لكن قد نحتاج ضبط الحالات الخطأ والضغط أكثر.
ما سنعدّله (بدون تنفيذ الآن – للنقاش)
الفاتورة (Invoice):
إبقاء المسار المتخصص: POST /api/v1/requests/create-invoice بالحقل: invoice_image.
الإبقاء على المسار الموحد كخطة B: POST /api/v1/requests بالحقل: image وtype: 'invoice'.
تأكيد:
تمرير employee_id, vendor_name, amount, description?.
ضغط الصورة قبل الرفع.
عرض رسالة واضحة عند 400 مع تفاصيل errors.
طلب الغسيل (Car Wash):
تعديل أسماء حقول الصور لتطابق الوثائق:
بدلاً من: plate_image, front_image, back_image, right_side_image, left_side_image
إلى: photo_plate, photo_front, photo_back, photo_right_side, photo_left_side
استخدام نفس الأسماء في المسارين:
المتخصص: POST /api/v1/requests/create-car-wash (إن كان موجود)
الموحد: POST /api/v1/requests مع type: 'car_wash'
تأكيد تمرير:
employee_id, vehicle_id أو manual_car_info عند الإدخال اليدوي، وservice_type وrequested_date?.
ضغط كل الصور قبل الرفع، والتحقق من وجودها قبل إضافتها إلى FormData (تجنب null).
تحسينات عامة للرفع
إضافة Content-Type تلقائياً: Dio يضبطه مع FormData، لا حاجة لضبطه يدوياً.
استخدام اسم ملف واضح وديناميكي لكل صورة.
تسجيل كامل الرسالة عند 400/413:
400: استخراج error/message/errors.
413: تقليل دقة الصورة أكثر (نسبة وجودة الضغط) وإعادة المحاولة.
التحقق قبل الرفع:
وجود الملف فعلاً على المسار.
حجم الصورة بعد الضغط مناسب (< 1–2MB إذا أمكن).
المصادقة:
تمرير JWT في الهيدر تلقائياً (موجود لدينا).
عند 401 إعادة المحاولة بعد تجديد التوكن.
نقاط نتحقق منها معك قبل التنفيذ
أسماء الحقول الموثّقة لرفع الفاتورة: هل السيرفر يطلب invoice_image أم image فقط؟ (لدينا كلاهما كخطة A/B، لكن نريد تأكيدك.)
Endpoint المتخصص لطلب الغسيل: هل فعّال لديكم أم نستخدم الموحد فقط؟
هل واجهتم رسائل خطأ محددة (400/413) أثناء الرفع؟ إن توفرت، أرسل سطرين من الـ log.
إذا وافقت:
سأغيّر حقول صور الغسيل إلى صيغة photo_*.
سأشدّد ضغط الصور ومعالجة أخطاء 400/413 برسائل أوضح.
سأتأكد أن شاشة الفاتورة وطلب الغسيل ترسل نفس ملف الصورة المختار فعلياً.